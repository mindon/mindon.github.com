var readonly;(function(){function e(e){var a=e.naturalWidth,t=e.naturalHeight;if(a*t>1024*1024){var r=document.createElement("canvas");r.width=r.height=1;var i=r.getContext("2d");i.drawImage(e,-a+1,0);return i.getImageData(0,0,1,1).data[3]===0}else{return false}}function a(e,a,t){var r=document.createElement("canvas");r.width=1;r.height=t;var i=r.getContext("2d");i.drawImage(e,0,0);var s=i.getImageData(0,0,1,t).data;var n=0;var o=t;var d=t;while(d>n){var c=s[(d-1)*4+3];if(c===0){o=d}else{n=d}d=o+n>>1}var l=d/t;return l===0?1:l}function t(e,a,t){var i=document.createElement("canvas");r(e,i,a,t);return i.toDataURL("image/jpeg",a.quality||.8)}function r(t,r,s,n){var o=t.naturalWidth,d=t.naturalHeight;if(!(o+d))return;var c=s.width,l=s.height;var f=r.getContext("2d");f.save();i(r,f,c,l,s.orientation);var h=e(t);if(h){o/=2;d/=2}var u=1024;var m=document.createElement("canvas");m.width=m.height=u;var g=m.getContext("2d");var v=n?a(t,o,d):1;var y=Math.ceil(u*c/o);var p=Math.ceil(u*l/d/v);var w=0;var C=0;while(w<d){var $=0;var b=0;while($<o){g.clearRect(0,0,u,u);g.drawImage(t,-$,-w);f.drawImage(m,0,0,u,u,b,C,y,p);$+=u;b+=y}w+=u;C+=p}f.restore();m=g=null}function i(e,a,t,r,i){switch(i){case 5:case 6:case 7:case 8:e.width=r;e.height=t;break;default:e.width=t;e.height=r}switch(i){case 2:a.translate(t,0);a.scale(-1,1);break;case 3:a.translate(t,r);a.rotate(Math.PI);break;case 4:a.translate(0,r);a.scale(1,-1);break;case 5:a.rotate(.5*Math.PI);a.scale(1,-1);break;case 6:a.rotate(.5*Math.PI);a.translate(0,-r);break;case 7:a.rotate(.5*Math.PI);a.translate(t,-r);a.scale(-1,1);break;case 8:a.rotate(-.5*Math.PI);a.translate(-t,0);break;default:break}}var s=window.URL&&window.URL.createObjectURL?window.URL:window.webkitURL&&window.webkitURL.createObjectURL?window.webkitURL:null;function n(e){if(window.Blob&&e instanceof Blob){if(!s){throw Error("No createObjectURL function found to create blob url")}var a=new Image;a.src=s.createObjectURL(e);this.blob=e;e=a}if(!e.naturalWidth&&!e.naturalHeight){var t=this;e.onload=e.onerror=function(){var e=t.imageLoadListeners;if(e){t.imageLoadListeners=null;for(var a=0,r=e.length;a<r;a++){e[a]()}}};this.imageLoadListeners=[]}this.srcImage=e}n.prototype.render=function(e,a,i){if(this.imageLoadListeners){var n=this;this.imageLoadListeners.push(function(){n.render(e,a,i)});return}a=a||{};var o=this.srcImage.naturalWidth,d=this.srcImage.naturalHeight,c=a.width,l=a.height,f=a.maxWidth,h=a.maxHeight,u=!this.blob||this.blob.type==="image/jpeg";if(c&&!l){l=d*c/o<<0}else if(l&&!c){c=o*l/d<<0}else{c=o;l=d}if(f&&c>f){c=f;l=d*c/o<<0}if(h&&l>h){l=h;c=o*l/d<<0}var m={width:c,height:l};for(var g in a)m[g]=a[g];var v=e.tagName.toLowerCase();if(v==="img"){e.src=t(this.srcImage,m,u)}else if(v==="canvas"){r(this.srcImage,e,m,u)}if(typeof this.onrender==="function"){this.onrender(e)}if(i){i()}if(this.blob){this.blob=null;s.revokeObjectURL(this.srcImage.src)}};if(typeof define==="function"&&define.amd){define([],function(){return n})}else{window.MegaPixImage=n}})();if(!window._CLICK){window._CLICK="ontouchstart"in window?"tap":"click"}var reqAnimationFrame=function(){return window[Hammer.prefixed(window,"requestAnimationFrame")]||function(e){window.setTimeout(e,1e3/60)}}();var ds=[0,0,1,0,0,0,1],readonly=true;var toastTid,toastOb;function toast(e,a){if(toastTid)clearTimeout(toastTid);if(typeof e=="number")e=tif[lang][""+e]||"";var t=$("#mytoast");if(!e){t.hide();t=null;return}if(t.length==0){$(document.body).append('<div id="mytoast"><div>');t=$("#mytoast");t.click(function(){$(this).hide()})}t.html(e).show();t=null;if(!a)toastTid=setTimeout(function(){$("#mytoast").hide()},5e3)}(function(){var e=$("#myarea").get(0);var a=0,t=0;var r=0,i=0;var s=false;var n;var o=new Hammer.Manager(document.body);o.add(new Hammer.Pan({threshold:0,pointers:0}));o.add(new Hammer.Swipe).recognizeWith(o.get("pan"));o.add(new Hammer.Rotate({threshold:0})).recognizeWith(o.get("pan"));o.add(new Hammer.Pinch({threshold:0})).recognizeWith([o.get("pan"),o.get("rotate")]);o.on("panstart panmove",f);o.on("rotatestart rotatemove",g);o.on("pinchstart pinchmove",u);function d(e){if(!e)e=[0,0,1,0,0,0,1];t=0;i=0;n={translate:{x:a+e[0],y:r+e[1]},scale:e[2],angle:e[3],rx:e[4],ry:e[5],rz:e[6]};l()}function c(){var a=["translate3d("+n.translate.x+"px, "+n.translate.y+"px, 0)","scale("+n.scale+", "+n.scale+")","rotate3d("+n.rx+","+n.ry+","+n.rz+","+n.angle+"deg)"];ds=[n.translate.x,n.translate.y,n.scale,n.angle,n.rx,n.ry,n.rz];a=a.join(" ");e.style.webkitTransform=a;e.style.mozTransform=a;e.style.transform=a;s=false}function l(){if(!s){reqAnimationFrame(c);s=true}}function f(e){if(readonly||$(e.target).hasClass("nopan")||$(e.target).parent().hasClass("nopan"))return true;if(e.type=="panstart"){a+=t;r+=i;t=0;i=0;n.translate={x:a,y:r}}else{t=e.deltaX;i=e.deltaY;n.translate={x:a+e.deltaX,y:r+e.deltaY}}l()}var h=1;function u(a){if(readonly)return true;if(a.type=="pinchstart"){h=n.scale||1}e.className="";n.scale=h*a.scale;l()}var m=0;function g(a){if(readonly)return true;if(a.type=="rotatestart"){m=n.angle||0}e.className="";n.rz=1;n.angle=m+a.rotation;l()}window.resetEl=d})();var upSrc="";function getMyOpts(e,a){var t=ds[0],r=ds[1];t+=refer.left+refer.offset.x;r+=refer.top+refer.offset.y;var i=Math.max(e/refer.width,a/refer.height);var s={x:refer.width-e/i,y:refer.height-a/i};t+=s.x/2;r+=s.y/2;var n=1;var o=ds[3];var d=(refer.width-s.x)/refer.ratio,c=(refer.height-s.y)/refer.ratio;var l={x:t/refer.ratio-(ds[2]*d-d)/2,y:r/refer.ratio-(ds[2]*c-c)/2,scale:n,angle:o,w:ds[2]*d,h:ds[2]*c};return l}var A2RAD=Math.PI/180;function drawMe(e,a,t){var r=t.x||0,i=t.y||0;var s=t.scale||1,n=(t.angle||0)*A2RAD;e.save();var o=t.w,d=t.h;var c=o/2,l=d/2;var f=r,h=i;if(n!=0){e.translate(c,l);e.rotate(n);e.translate(-c,-l);f=r*Math.cos(n)+i*Math.sin(n);h=-r*Math.sin(n)+i*Math.cos(n)}if(false&&s!=1){e.scale(s,s);f+=(o*s-o)/2;h+=(d*s-d)/2}e.drawImage(a,f,h,o,d);e.restore()}var aCanvas,aCTX;function saveWork(){var e=card.width,a=card.height;if(!aCTX){aCanvas=document.createElement("canvas");aCanvas.style.display="none";document.body.appendChild(aCanvas);$(aCanvas).attr({width:e,height:a});aCTX=aCanvas.getContext("2d")}aCTX.fillStyle="#FFFFFF";aCTX.fillRect(0,0,e,a);var t=$("#myface").get(0);var r=getMyOpts(t.width,t.height);drawMe(aCTX,t,r);aCTX.drawImage($("#myimg").get(0),0,0,e,a);this.href=aCanvas.toDataURL()}$("#upform").on("submit",function(e){e.preventDefault();var a=new FormData(this);upload(a)});function upload(e,a,t){toast(99,!0);$.ajax({type:"POST",url:t?t:$("#upform").attr("action"),data:e,dataType:"text",contentType:a?a:$("#upform").attr("enctype"),processData:false,success:function(e){var a;if(typeof e=="string"){try{a=JSON.parse(e.replace(/^\s+|\s+$/g,"").replace(/\}[^a-z]*$/,"}"))}catch(t){}}else{a=e}if(a&&a.url){upSrc=a.url;toast(1)}else{toast(-1,!0)}},error:function(e,a,t){toast(-1,!0)}})}function dropChangeHandler(e){toast(9,!0);e.preventDefault();var a=e.dataTransfer||e.target,t=a&&a.files&&a.files[0],r={maxWidth:8192,canvas:true};if(!t){return}var i=new MegaPixImage(t);var s=$("#myface").get(0);i.render(s,{maxWidth:($("#myarea").width()<card.width/2?4:1)*$("#myarea").width(),maxHeight:($("#myarea").width()<card.width/2?4:1)*$("#myarea").height(),quality:.85},function(){$("#myarea").css("background-image","url("+s.src+")");var e=";base64,",a=s.src.indexOf(e);var t=s.src.substr(0,a).match(/image\/([a-z]+)/);a+=e.length;setTimeout(function(){upload((t?t[1].replace(/jpeg/i,"jpg"):"jpg")+";"+s.src.substr(a),"application/x-www-form-urlencoded");i=s=null})})}$("#mypick").on("change",dropChangeHandler);var ubase="https://tips.wechat.com/mojime/",ubase2="https://translate.wechat.com/mojime/";var cardStyle=Qp.i||"";var card;var shareConf;var refer={};function adjArea(){if(!card)return false;var e={w:$("#mystage").width(),h:$("#mystage").height()};var a=Math.max(e.w/card.width,e.h/card.height);var t={x:(card.width*a-e.w)/2,y:(card.height*a-e.h)/2};var r=card.area;refer={left:r.x*a-t.x,top:r.y*a-t.y,width:r.w*a,height:r.h*a};$("#myarea").css(refer);refer.stage=e;refer.ratio=a;refer.offset=t;adjFile()}function adjFile(){if($("#myselect").length==0)return;var e=$("#myselect").offset();if(e)$("#upform").css({left:e.left,top:e.top,width:$("#myselect").width(),height:$("#myselect").height()})}function setMoji(e){$("#myface").attr("src",e);$("#myarea").css("background-image",'url("'+e+'")')}var DEFAULT_TITLE=document.title;var SHARE_TITLE=$("#t_SHARE "+lang).text();var SHARE_TITLE2=SHARE_TITLE;var SharePack={appid:"",img_url:"ecard/"+cardStyle+"-thumb.jpg",img_width:"120",img_height:"120",link:window.location.href,desc:SHARE_TITLE,title:DEFAULT_TITLE};$('meta[name="description"], meta[property="og:description"]').attr("content",SHARE_TITLE);function styCard(e){if(!cards[e])return false;var a="ecard/"+e+".png";$("#myimg").attr("src",a);$("#mymask").css("background-image",'url("'+a+'")');if(card)card.last=ds;card=cards[e];$("#mysave").attr("download","mojime-holiday-"+e+".png");if(card.text){$("#mystage").addClass("text");var t=card.text.style||"";$("#mytext").attr("class",t?"nopan dont "+t:"nopan dont");$("#the-text").val(card.text.default||"")}else if($("#mystage").hasClass("text")){$("#the-text").val("");$("#mystage").removeClass("text")}if(card.last){ds=card.last}else{if(shareConf&&shareConf.d&&shareConf.i==e&&(!shareConf.u||$("#myface").attr("src").indexOf(shareConf.u)>-1)){ds=shareConf.d.concat(0,0,1)}else{ds=[0,0,1,0,0,0,1];if(card.area.deg){ds[3]=card.area.deg}}}cardStyle=e;SharePack.img_url=window.location.href.replace(/[^\/]*[\?#].*$/,"")+"ecard/"+cardStyle+"-thumb.jpg";adjArea();resetEl(ds);if(card.music==false){$("#taskbar").addClass("no-music")}else if($("#taskbar").hasClass("no-music")){$("#taskbar").removeClass("no-music")}}var stylisted=false,skipIds=["mystyle","mycreate","listprev","listnext","stylist","listct"];function stylize(e){if($(this).hasClass("active")){return}$("#stylist:visible").animate({height:0},"fast");var a=$(this).parent().find("img.active");if(a.length>0){a.removeClass("active")}$(this).parent().find("img.active").removeClass("active");var t=$(this).addClass("active").attr("src").match(/ecard\/(.+)-thumb\.jpg$/);if(t){styCard(t[1]);if(a.length===0)$("#mypick").click();window.ga&&ga("send","event","button","click","E-Card Style = "+cardStyle)}}function stypage(e){$("#listct img").unbind(_CLICK);if(e==-1&&cardThumbPos>0){cardThumbPos-=4;if(cardThumbPos<0)cardThumbPos=0}else if(e==1&&cardThumbPos<cardStyles.length-1){cardThumbPos+=4}else if(e!=0){return}if(cardThumbPos==0){if(!$("#listprev").hasClass("none"))$("#listprev").addClass("none")}else if($("#listprev").hasClass("none")){$("#listprev").removeClass("none")}if(cardThumbPos+4>=cardStyles.length){if(!$("#listnext").hasClass("none"))$("#listnext").addClass("none")}else if($("#listnext").hasClass("none")){$("#listnext").removeClass("none")}var a="",t=cardStyles.slice(cardThumbPos,cardThumbPos+4);for(var r=0;r<t.length;r++){var i=t[r];a+='<img src="ecard/'+i+'-thumb.jpg" class="'+(cards[i].be?cards[i].be:"")+(i==cardStyle?" active":"")+'" />'}$("#listct").html(a).find("img").on(_CLICK,stylize)}function styup(){if(!stylisted){stylisted=true;setMoji("assets/demo.jpg");$("#stylist").html('<div id="thumblist" class="nopan"><div id="listprev" class="none"></div><div id="listct" class="nopan"></div><div id="listnext"></div></div>');stypage(0);$("#listprev").on(_CLICK,function(){if(!$(this).hasClass("none"))stypage(-1)});$("#listnext").on(_CLICK,function(){if(!$(this).hasClass("none"))stypage(1)});$("#myselect").on(_CLICK,function(){$("#mypick").click()});$("#mysave").on(_CLICK,saveWork);setTimeout(adjFile,50)}if(!$(document.body).hasClass("single")){$("#stylist").show().animate({height:95},"fast")}}$(function(){if(Qp.be&&/^[\w-\.]+$/.test(Qp.be)){$("#stylist").addClass(Qp.be)}if(Qp.d){shareConf=JSON.parse(B64.decode(Qp.d));var e=shareConf;if(e){var a=e.d;if(e.u){upSrc=e.u;if(upSrc.charAt(0)=="@"){upSrc=ubase+upSrc.substr(1)}else if(upSrc.charAt(0)==">"){upSrc=ubase2+upSrc.substr(1)}setMoji(upSrc);readonly=true}if(e.i){styCard(e.i)}if(e.t){$("#the-text").val(e.t)}}}else{styCard(cardStyle||defaultStyle)}adjArea();if(shareConf&&shareConf.d){shareConf.d[0]*=refer.ratio;shareConf.d[1]*=refer.ratio;ds=shareConf.d.concat(0,0,1);resetEl(ds)}else{if(card.area.deg){ds[3]=card.area.deg}resetEl(ds)}var t=ds.slice(0);$(window).resize(adjArea);$(document.body).on("dblclick",function(e){var a=e.target;if(readonly||a&&($(a).hasClass("nopan")||$(a).parent().hasClass("nopan")))return;t[3]=card.area.deg||0;resetEl(t)}).on(_CLICK,function(e){if(readonly)return;var a=e.target;if(a&&skipIds.indexOf(a.id)==-1&&a.parentNode!=document.getElementById("stylist")){$("#stylist:visible").animate({height:0},"fast")}});$("#myarea").on(_CLICK,function(){if(readonly||$(this).css("background-image").indexOf("assets/demo.jpg")===-1)return;$("#mypick").click()});$("#mystyle").on(_CLICK,function(){setTimeout(function(){styup()},10)})});function shareV(e){var a=ds.slice(0,4);a[0]=a[0]/refer.ratio;a[1]=a[1]/refer.ratio;if(!e)e=upSrc;if(e.indexOf(ubase)===0){e="@"+e.substr(ubase.length)}else if(e.indexOf(ubase2)===0){e=">"+e.substr(ubase2.length)}var t={i:cardStyle,u:e||"assets/demo.jpg",d:a};if($("#mystage").hasClass("text"))t.t=$("#the-text").val();return B64.encode(JSON.stringify(t))}if(SharePack.img_url.indexOf("://")<0){SharePack.img_url=window.location.href.replace(/[^\/]*[\?#].*$/,"")+SharePack.img_url}function shareCb(e){}function shareLink(e){if(!e){e=SharePack.link}if(e){e=e.replace(/([&\?])(af|d)=[^&#]+/,"");e+=(e.indexOf("?")>0?"&":"?")+(window.af?"af="+window.af+"&":"")+"d="+shareV();return e}else{return window.location.href}}function wxTask(e,a){var t=window.ga;if(!upSrc){alert(tif[lang]["-3"]);t&&t("send","event","button","click","E-Card Share Failed - "+cardStyle);return false}if(!a)a=SharePack;var r=a.url||a.link;r=shareLink(r);if(a.url){a.url=r}else{a.link=r}WeixinJSBridge.invoke(e,a,shareCb);t&&t("send","event","button","click","E-Card Share - "+cardStyle+": "+e)}function onWxReady(){document.getElementsByTagName("html")[0].className="wechat";WeixinJSBridge.on("menu:share:appmessage",function(e){wxTask("sendAppMessage")});WeixinJSBridge.on("menu:share:timeline",function(e){wxTask("shareTimeline")});WeixinJSBridge.on("menu:share:weibo",function(e){wxTask("shareWeibo",{content:SharePack.title,url:SharePack.link})});WeixinJSBridge.on("menu:share:facebook",function(e){wxTask("shareFB")})}if(document.addEventListener){document.addEventListener("WeixinJSBridgeReady",onWxReady,false)}else if(document.attachEvent){document.attachEvent("WeixinJSBridgeReady",onWxReady);document.attachEvent("onWeixinJSBridgeReady",onWxReady)}$(function(){$("#myshare").on(_CLICK,function(){readonly=true;window.touchEmulatorOff=true;$("#mytips").show().find("input").val(shareLink()).focus()});$("#mycreate").on(_CLICK,function(e){e.stopPropagation();$("#mystage").removeClass("readonly");if(card.text&&card.text.default){$("#the-text").val(card.text.default)}readonly=false;setTimeout(function(){styup();$("#mystage").removeClass("create")},10)});$("#mytips").on(_CLICK,function(e){if(e.target.tagName=="INPUT")return true;$(this).hide();readonly=false;window.touchEmulatorOff=false});$("#mytips .web input").focus(function(){this.select()});$("#mytry").on(_CLICK,function(){window.open($("#mytips .web input").val())})});