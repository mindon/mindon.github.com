import*as echarts from"https://lib.baomitu.com/echarts/5.1.1/echarts.esm.min.js";const c=document.createElement("canvas"),ctx=c.getContext("2d"),dotCached={};function dot(e){return dotCached[e]||(ctx.clearRect(0,0,c.width,c.height),ctx.beginPath(),ctx.fillStyle="#ffffff",ctx.arc(32,32,28,0,2*Math.PI),ctx.fill(),ctx.strokeStyle=e,ctx.lineWidth=6,ctx.stroke(),dotCached[e]=`image://${c.toDataURL("img/png")}`),dotCached[e]}c.width=64,c.height=64;const option={darkMode:!1,color:["#5470c6","#91cc75","#fac858","#ee6666","#73c0de","#3ba272","#fc8452","#9a60b4","#ea7ccc"],backgroundColor:"#ffffff",toolbox:{bottom:20,feature:{saveAsImage:{title:"下载",type:"png",name:`md_status_by_mindon-${(new Date).getTime()}`,pixelRatio:2,excludeComponents:["toolbox","dataZoom"]}}},polar:{center:["50%","54%"]},angleAxis:{name:"时间",type:"value",startAngle:90,axisLabel:{formatter:function(e,t){const n=e/360*24*60;return[`0${Math.floor(n/60)}`.slice(-2),("0"+n%60).slice(-2)].join(":")}},splitArea:{show:!0}},radiusAxis:{name:"血糖\n（mmol/l）",nameLocation:"start",min:0,axisPointer:{show:!0,snap:!0}},legend:{data:[]},series:[]};function flip(){const e=document.querySelector("#box").classList;e.contains("flipped")?e.remove("flipped"):e.add("flipped")}function minutes(e){const t=e.indexOf(":");return 60*parseInt(e.substr(0,t),10)+parseInt(e.substr(t+1),10)}const myChart=echarts.init(document.querySelector("#main"),null,{renderer:"png"}),beforeMeal=/餐前|饭前|空/,afterMeal=/餐后|饭后|2h|2H/,rule=/^((\d{4}[-/])?\d{1,2}[-/]\d{1,2})?[,\t]\d{1,2}:\d{1,2}[,\t]\d+(\.\d+)?([,\t][^\n]*)?$/;function view(e){const t=e.map?e:e.split(/\r?\n/),n=[],o={},r={},l=new Date,c=l.getFullYear(),i=[`0${l.getMonth()+1}`.slice(-2),`0${l.getDate()}`.slice(-2)].join("-");for(let e=0;e<t.length;e++){if(t[e].length<3||!rule.test(t[e]))continue;const l=t[e].indexOf("\t")>-1?t[e].split("\t"):t[e].split(",");let c=l[0];l[1];c||(c=i),c=c.split(/[-/]/).map((e=>1==e.length?`0${e}`:e)).join("-"),n.indexOf(c)>=0?(o[c].push([l[1],l[2]]),r[c].push(l[3]||"")):(o[c]=[[l[1],l[2]]],r[c]=[l[3]||""],n.push(c))}let a=0,s=6;const u=[];option.series=[],n.sort().reverse(),n.slice(0,7).forEach(((e,t)=>{const l=e;0==e.indexOf(c)&&(e=e.substr(c.length+1)),u.push(e),option.series.push({coordinateSystem:"polar",name:e,type:"line",z:n.length-t,lineStyle:{width:Math.max(s--,1)},data:o[l].map(((e,n)=>{const o=parseFloat(e[1]),c=r[l][n];return o>a&&(a=o),{value:[o,.25*minutes(e[0])],symbol:beforeMeal.test(c)?dot(option.color[t]):afterMeal.test(c)?"circle":"diamond"}})),symbolSize:16})})),option.legend.data=u,option.radiusAxis.max=Math.round(a+.5),myChart.setOption(option),setTimeout((()=>{const e=.5*document.querySelector("#main").offsetWidth,t=.54*document.querySelector("#main").offsetHeight,n=e=>t-(myChart.convertToPixel({seriesIndex:0},[e,0])||[0,0])[1],o=10,r=16,l=current(3),c=new QRious({background:"transparent",foreground:"black",level:"L",padding:0,value:`https://mindon.github.io/d/m.html?z=${btoa(unescape(encodeURIComponent(l.join("\n"))))}`});myChart.setOption({graphic:{elements:[{type:"circle",shape:{cx:e,cy:t,r:n(5.4)},style:{fill:"none",stroke:"rgba(0,116,255,.2)",lineWidth:n(6.9)-n(3.9)}},{type:"circle",shape:{cx:e,cy:t,r:n(9.45)},style:{fill:"none",stroke:"rgba(255,255,64,.3)",lineWidth:n(11.1)-n(7.8)}},{type:"rect",shape:{x:2*e-o-5,y:51,width:10,height:10},style:{fill:"#999999"}},{type:"text",x:2*e-o-32,y:49,style:{fill:"#3399ff",text:"其它"}},{type:"circle",shape:{cx:2*e-o,cy:36,r:6},style:{fill:"#999999"}},{type:"text",x:2*e-o-32,y:29,style:{fill:"#3399ff",text:"餐后"}},{type:"circle",shape:{cx:2*e-o,cy:r,r:6},style:{fill:"none",stroke:"#999999"}},{type:"text",x:2*e-o-32,y:9,style:{fill:"#3399ff",text:"餐前"}},{type:"text",x:e-98,y:t,style:{text:"developed by mindon@live.com",fill:"rgba(128,128,128,0.1)"}},{type:"text",x:2*e-o-25,y:66,style:{text:"❜❜",fill:"#ff3300",fontSize:39},onclick:flip},{type:"image",x:32,y:2*t-160,style:{image:c.toDataURL()}}]}})}))}const x=function(){const e=location.search.match(/[?&]z=([^&]+)/);if(!e)return"";try{return decodeURIComponent(escape(atob(e[1])))}catch(e){}return""}();let raw=x||localStorage.getItem("d");function edit(e){document.querySelector("#mydata tbody").innerHTML="";const t=e.split(/\r?\n/),n=(new Date).getFullYear();const o=document.querySelector("#record").content.querySelector("tr"),r=document.createDocumentFragment(),l=document.importNode(o,!0);l.querySelector("td.remove").classList.add("new"),r.appendChild(l);const c=new Date,i=[c.getFullYear(),`0${c.getMonth()+1}`.slice(-2),`0${c.getDate()}`.slice(-2)].join("/"),a=[];for(let e=0;e<t.length;e++){if(t[e].length<2||!rule.test(t[e]))continue;const o=t[e].indexOf("\t")>-1?t[e].split("\t"):t[e].split(",");let r=o[0],l=o[1];r||(r=i);const c=r.split(/[-/]/);2==c.length&&c.unshift(n),r=c.map((e=>1==e.toString().length?`0${e}`:e)).join("-"),a.push([r,l.split(":").map((e=>1==e.length?`0${e}`:e)).join(":"),o[2],o[3]||""])}a.sort(((e,t)=>e[0]>t[0]?-1:e[0]<t[0]?1:e[1]>t[1]?-1:e[1]<t[1]?1:0)),a.forEach((e=>{const t=document.importNode(o,!0);t.querySelector("input.date").value=e[0],t.querySelector("input.time").value=e[1],t.querySelector("input.status").value=e[2],t.querySelector("input.memo").value=e[3],r.appendChild(t)})),document.querySelector("#mydata tbody").appendChild(r),verify()}function add(){const e=document.querySelector("#record").content.querySelector("tr"),t=document.importNode(e,!0);t.querySelector("td.remove").classList.add("new");const n=document.querySelector("#mydata tbody");return n.insertBefore(t,n.firstChild),t}function verify(e){let t=0;[].forEach.call(document.querySelectorAll("#mydata tbody input.status"),(n=>{const o=n.parentElement.parentElement.querySelector("input.time");n.value&&(o.checkValidity()?t++:!e&&o.reportValidity())})),document.querySelector("#mycount").innerText=t}function current(e){const t=[],n=`${(new Date).getFullYear()}-`,o=[],r={};if([].forEach.call(document.querySelectorAll("#mydata tbody input.status"),(e=>{const l=e.parentElement.parentElement,c=l.querySelector("input.time");if(e.value)if(c.checkValidity()){const e=l.querySelector("input.date").value.replace(/\//g,"-").replace(n,""),i=t.length;o.indexOf(e)<0?(o.push(e),r[e]=[i]):r[e].push(i),t.push([e,c.value,l.querySelector("input.status").value,l.querySelector("input.memo").value].join(","))}else c.reportValidity()})),e>0){const n=o.sort().reverse().slice(0,e);return t.filter(((e,t)=>{for(let e=0;e<n.length;e++)if(r[n[e]].indexOf(t)>-1)return!0;return!1}))}return t}raw||(raw="日期,时间,血糖,备注,\n6-4,22:49,7.7,睡前,\n6-4,18:36,8.5,晚餐前,\n6-4,14:34,11,午餐后,\n6-4,11:50,8,午餐前,\n6-4,6:38,4.5,空腹,\n6-3,21:22,6.1,睡前,\n6-3,18:52,9.0,晚餐前,\n6-3,14:53,10.7,午餐后,\n6-3,9:12,7.8,早餐后,\n6-3,6:30,8,空腹,\n6-3,2:04,3.8,低血糖,\n6-2,22:05,6.4,睡前,\n6-2,17:27,12.7,晚餐前,\n6-2,14:17,10.7,午餐后,\n6-2,11:01,5.3,午餐前,\n6-2,7:14,7.9,空腹,"),view(raw),document.querySelector("form").onkeypress=function(e){const t=e.target;if("Enter"==e.key||13==e.keyCode){if(t.checkValidity&&!t.checkValidity())return t.focus(),void t.reportValidity();if(t.classList.contains("memo")){const e=t.parentElement.parentElement.querySelector("td.new");if(e)return add().querySelector("input").focus(),e.classList.remove("new"),void verify();t.parentElement.parentElement.nextElementSibling.querySelector("input").focus()}else t.parentElement.nextElementSibling.querySelector("input").focus()}},document.querySelector("form").onclick=function(e){const t=e.target;if("A"!=t.tagName)return;if(t.parentElement.classList.contains("new"))return t.parentElement.classList.remove("new"),void add();const n=t.parentElement.parentElement,o=n.querySelector("input.status").value;(0==o.length||confirm(`删除 ${n.querySelector("input.time").value} 血糖 ${o} 记录？`))&&(n.remove(),verify(!0))},document.querySelector("a.reset").onclick=function(e){const t=document.querySelector("#mydata tbody"),n=t.querySelectorAll("td.remove").length-t.querySelectorAll("td.new").length;0!=n&&confirm(`确认清空血糖记录数据（共 ${n} 条）？`)&&([].forEach.call(t.querySelectorAll("td.remove"),(e=>{e.classList.contains("new")||e.parentElement.remove()})),localStorage.removeItem("d"))},document.querySelector("a.apply").onclick=function(e){const t=current();localStorage.setItem("d",t.join("\n")),view(t),document.querySelector("#toggleCard").click()};const dl=document.createElement("a"),now=new Date;dl.target="_blank",dl.download=`血糖记录-${[now.getFullYear(),`0${now.getMonth()+1}`.slice(-2),`0${now.getDate()}`.slice(-2)].join("")}.csv`,document.querySelector("a.total").onclick=function(e){const t=btoa(unescape(encodeURIComponent(`日期,时间,血糖,备注\n${current().join("\n")}`)));dl.href=`data:text/csv;base64,${t}`,dl.click()},edit(raw),document.querySelector("#myfile").onchange=function(e){Promise.all([].slice.call(e.target.files,0).map((e=>new Promise(((t,n)=>{const o=new FileReader;o.onload=function(){t(o.result)},o.onerror=function(e){n(e)},o.readAsText(e)}))))).then((e=>{edit(e.join("\n").replace(/\n{2,}/g,"\n"))}))},document.querySelector("#toggleCard").onclick=flip,document.querySelector("#enter").onclick=flip;
