import*as echarts from"https://lib.baomitu.com/echarts/5.1.1/echarts.esm.min.js";const c=document.createElement("canvas"),ctx=c.getContext("2d"),dotCached={};function dot(e){return dotCached[e]||(ctx.clearRect(0,0,c.width,c.height),ctx.beginPath(),ctx.fillStyle="#ffffff",ctx.arc(32,32,28,0,2*Math.PI),ctx.fill(),ctx.strokeStyle=e,ctx.lineWidth=6,ctx.stroke(),dotCached[e]=`image://${c.toDataURL("img/png")}`),dotCached[e]}c.width=64,c.height=64;const option={darkMode:!1,color:["#5470c6","#91cc75","#fac858","#ee6666","#73c0de","#3ba272","#fc8452","#9a60b4","#ea7ccc"],backgroundColor:"#ffffff",toolbox:{bottom:20,feature:{saveAsImage:{title:"下载",type:"png",name:`md_status_by_mindon-${(new Date).getTime()}`,pixelRatio:2,excludeComponents:["toolbox","dataZoom"]}}},polar:{center:["50%","54%"]},angleAxis:{name:"时间",type:"value",startAngle:90,axisLabel:{formatter:function(e,t){const n=e/360*24*60;return[`0${Math.floor(n/60)}`.slice(-2),("0"+n%60).slice(-2)].join(":")}},splitArea:{show:!0}},radiusAxis:{name:"血糖\n（mmol/l）",nameLocation:"start",min:0,axisPointer:{show:!0,snap:!0}},legend:{data:[]},series:[]};function $(e){return document.querySelector(e)}function each(e,t){[].forEach.call(document.querySelectorAll(e),t)}function flip(){const e=$("#box").classList;e.contains("flipped")?e.remove("flipped"):e.add("flipped")}function count(e){$("#mypicked").innerText=e>0?`/ ${e} 天`:"/ 全部"}function minutes(e){const t=e.indexOf(":");return 60*parseInt(e.substr(0,t),10)+parseInt(e.substr(t+1),10)}const myChart=echarts.init($("#main"),null,{renderer:"png"});window.onresize=function(){myChart.resize(),window.cacur&&window.cacur()};const beforeMeal=/餐前|饭前|空/,afterMeal=/餐后|饭后|2h|2H/,rule=/^((\d{4}[-/])?\d{1,2}[-/]\d{1,2})?[,\t]\d{1,2}:\d{1,2}[,\t]\d+(\.\d+)?([,\t][^\n]*)?$/;function view(e,t){const n=e.map?e:e.split(/\r?\n/),o=[],i={},l={},c=new Date,r=c.getFullYear(),a=[`0${c.getMonth()+1}`.slice(-2),`0${c.getDate()}`.slice(-2)].join("-");for(let e=0;e<n.length;e++){if(n[e].length<3||!rule.test(n[e]))continue;const t=n[e].indexOf("\t")>-1?n[e].split("\t"):n[e].split(",");let c=t[0];t[1];c||(c=a),c=c.split(/[-/]/).map((e=>1==e.length?`0${e}`:e)).join("-"),o.indexOf(c)>=0?(i[c].push([t[1],t[2]]),l[c].push(t[3]||"")):(i[c]=[[t[1],t[2]]],l[c]=[t[3]||""],o.push(c))}let s=0,u=6;const d=[];option.series=[],o.sort().reverse(),count(t&&t.length>0?t.length:0),(t&&t.length>0?o.filter((e=>t.indexOf(e)>=0)):o).forEach(((e,t)=>{const n=e;0==e.indexOf(r)&&(e=e.substr(r.length+1)),d.push(e),option.series.push({coordinateSystem:"polar",name:e,type:"line",z:o.length-t,lineStyle:{width:Math.max(u--,1)},data:i[n].map(((e,o)=>{const i=parseFloat(e[1]),c=l[n][o];return i>s&&(s=i),{value:[i,.25*minutes(e[0])],symbol:beforeMeal.test(c)?dot(option.color[t]):afterMeal.test(c)?"circle":"diamond"}})),symbolSize:16})})),option.legend.data=d,option.radiusAxis.max=Math.round(s+.5),myChart.setOption(option,!0);const p=()=>{const e=.5*$("#main").offsetWidth,t=.54*$("#main").offsetHeight,n=e=>t-(myChart.convertToPixel({seriesIndex:0},[e,0])||[0,0])[1],o=10,i=16,l=current(5),c=new QRious({background:"transparent",foreground:"black",level:"L",padding:0,value:`https://mindon.github.io/d/m.html?z=${btoa(unescape(encodeURIComponent(x||l.join("\n"))))}`});myChart.setOption({graphic:{elements:[{type:"circle",shape:{cx:e,cy:t,r:n(5.4)},style:{fill:"none",stroke:"rgba(0,116,255,.2)",lineWidth:n(6.9)-n(3.9)}},{type:"circle",shape:{cx:e,cy:t,r:n(9.45)},style:{fill:"none",stroke:"rgba(255,255,64,.3)",lineWidth:n(11.1)-n(7.8)}},{type:"rect",shape:{x:2*e-o-5,y:51,width:10,height:10},style:{fill:"#999999"}},{type:"text",x:2*e-o-32,y:49,style:{fill:"#3399ff",text:"其它"}},{type:"circle",shape:{cx:2*e-o,cy:36,r:6},style:{fill:"#999999"}},{type:"text",x:2*e-o-32,y:29,style:{fill:"#3399ff",text:"餐后"}},{type:"circle",shape:{cx:2*e-o,cy:i,r:6},style:{fill:"none",stroke:"#999999"}},{type:"text",x:2*e-o-32,y:9,style:{fill:"#3399ff",text:"餐前"}},{type:"text",x:e-98,y:t,style:{text:"developed by mindon@live.com",fill:"rgba(128,128,128,0.1)"}},{type:"text",x:2*e-o-25,y:66,style:{text:"❜❜",fill:"#ff3300",fontSize:39},onclick:flip},{type:"image",x:32,y:2*t-160,style:{image:c.toDataURL()}}]}})};setTimeout(p),window.cacur=p}let x=function(){const e=location.search.match(/[?&]z=([^&]+)/);if(!e)return"";try{return decodeURIComponent(escape(atob(e[1])))}catch(e){}return""}(),raw=x||localStorage.getItem("d");function edit(e){const t=localStorage.getItem("p")?localStorage.getItem("p").split(","):void 0;$("#mydata tbody").innerHTML="";const n=e.split(/\r?\n/),o=(new Date).getFullYear();const i=$("#record").content.querySelector("tr"),l=document.createDocumentFragment(),c=document.importNode(i,!0);c.querySelector("td.remove").classList.add("new"),l.appendChild(c);const r=new Date,a=[r.getFullYear(),`0${r.getMonth()+1}`.slice(-2),`0${r.getDate()}`.slice(-2)].join("/"),s=[],u=[];for(let e=0;e<n.length;e++){if(n[e].length<2||!rule.test(n[e]))continue;const t=n[e].indexOf("\t")>-1?n[e].split("\t"):n[e].split(",");let i=t[0],l=t[1];i||(i=a);const c=i.split(/[-/]/);if(2==c.length){const e=c.join("-");u.indexOf(e)<0&&u.push(e),c.unshift(o)}else{const e=c[0]==o?1:0,t=c.slice(e).join("-");u.indexOf(t)<0&&u.push(t)}i=c.map((e=>1==e.toString().length?`0${e}`:e)).join("-"),s.push([i,l.split(":").map((e=>1==e.length?`0${e}`:e)).join(":"),t[2],t[3]||""])}const d=$("#pick");d.innerHTML=u.map((e=>`<option value="${e}"${t&&0!=t.length?t.indexOf(e)>-1?" selected":"":" selected"}>${e}</option>`)).join(""),d.setAttribute("size",u.length),s.sort(((e,t)=>e[0]>t[0]?-1:e[0]<t[0]?1:e[1]>t[1]?-1:e[1]<t[1]?1:0)),s.forEach((e=>{const t=document.importNode(i,!0);t.querySelector("input.date").value=e[0],t.querySelector("input.time").value=e[1],t.querySelector("input.status").value=e[2],t.querySelector("input.memo").value=e[3],l.appendChild(t)})),$("#mydata tbody").appendChild(l),verify()}function add(){const e=$("#record").content.querySelector("tr"),t=document.importNode(e,!0);t.querySelector("td.remove").classList.add("new");const n=$("#mydata tbody");return n.insertBefore(t,n.firstChild),t}function verify(e){let t=0;each("#mydata tbody input.status",(n=>{const o=n.parentElement.parentElement.querySelector("input.time");n.value&&(o.checkValidity()?t++:!e&&o.reportValidity())})),$("#mycount").innerText=t}function current(e){const t=[],n=`${(new Date).getFullYear()}-`,o=[],i={};each("#mydata tbody input.status",(e=>{const l=e.parentElement.parentElement,c=l.querySelector("input.time");if(e.value)if(c.checkValidity()){const e=l.querySelector("input.date").value.replace(/\//g,"-").replace(n,""),r=t.length;o.indexOf(e)<0?(o.push(e),i[e]=[r]):i[e].push(r),t.push([e,c.value,l.querySelector("input.status").value,l.querySelector("input.memo").value].join(","))}else c.reportValidity()}));const l=$("#pick"),c=[].slice.call(l.querySelectorAll("option")).map((e=>e.value));let r=0;if(o.forEach((e=>{if(c.indexOf(e)>=0)return;const t=document.createElement("option");t.value=e,t.text=e,t.selected=!0,l.insertBefore(t,l.firstChild),r++})),r>0&&l.setAttribute("size",o.length),e>0){const n=localStorage.getItem("p")?localStorage.getItem("p").split(","):void 0,l=o.sort().reverse().filter((e=>!(n&&n.length>0)||n.indexOf(e)>-1)).slice(0,e);return t.filter(((e,t)=>{for(let e=0;e<l.length;e++)if(i[l[e]].indexOf(t)>-1)return!0;return!1}))}return t}raw||(raw="日期,时间,血糖,备注,\n6-4,22:49,7.7,睡前,\n6-4,18:36,8.5,晚餐前,\n6-4,14:34,11,午餐后,\n6-4,11:50,8,午餐前,\n6-4,6:38,4.5,空腹,\n6-3,21:22,6.1,睡前,\n6-3,18:52,9.0,晚餐前,\n6-3,14:53,10.7,午餐后,\n6-3,9:12,7.8,早餐后,\n6-3,6:30,8,空腹,\n6-3,2:04,3.8,低血糖,\n6-2,22:05,6.4,睡前,\n6-2,17:27,12.7,晚餐前,\n6-2,14:17,10.7,午餐后,\n6-2,11:01,5.3,午餐前,\n6-2,7:14,7.9,空腹,"),view(raw,localStorage.getItem("p")?localStorage.getItem("p").split(","):void 0),$("form").onkeypress=function(e){const t=e.target;if("Enter"==e.key||13==e.keyCode){if(t.checkValidity&&!t.checkValidity())return t.focus(),void t.reportValidity();if(t.classList.contains("memo")){const e=t.parentElement.parentElement.querySelector("td.new");if(e)return add().querySelector("input").focus(),e.classList.remove("new"),void verify();t.parentElement.parentElement.nextElementSibling.querySelector("input").focus()}else t.parentElement.nextElementSibling.querySelector("input").focus()}},document.onclick=function(e){const t=e.target;if("SELECT"!=t.tagName&&"OPTION"!=t.tagName&&"mypicked"!=t.id){const e=$("#pick").classList;e.contains("show")&&e.remove("show")}},$("form").onclick=function(e){const t=e.target;if("A"!=t.tagName)return;if(t.parentElement.classList.contains("new"))return t.parentElement.classList.remove("new"),void add();if("mypicked"==t.id){const e=$("#pick").classList;return void(e.contains("show")?e.remove("show"):e.add("show"))}const n=t.parentElement.parentElement,o=n.querySelector("input.status").value;(0==o.length||confirm(`删除 ${n.querySelector("input.time").value} 血糖 ${o} 记录？`))&&(n.remove(),verify(!0))},$("a.reset").onclick=function(e){const t=$("#mydata tbody"),n=t.querySelectorAll("td.remove").length-t.querySelectorAll("td.new").length;0!=n&&confirm(`确认清空血糖记录数据（共 ${n} 条）？`)&&([].forEach.call(t.querySelectorAll("td.remove"),(e=>{e.classList.contains("new")||e.parentElement.remove()})),localStorage.removeItem("d"))},$("#pick").onblur=function(e){e.target.classList.remove("show"),count([].slice.call(document.querySelectorAll("#pick > option:checked")).length)},$("a.apply").onclick=function(e){const t=current();if($("form input.time").value&&$("form input.status").value){const e=$("td.remove").classList;e.contains("new")&&(e.remove("new"),add())}localStorage.setItem("d",t.join("\n"));const n=[];each("#pick > option:checked",(e=>{e.value&&n.push(e.value)})),localStorage.setItem("p",n.join(",")),x?location.href=`${location.pathname}`:(view(t,n),flip())};const dl=document.createElement("a"),now=new Date;dl.target="_blank",dl.download=`血糖记录-${[now.getFullYear(),`0${now.getMonth()+1}`.slice(-2),`0${now.getDate()}`.slice(-2)].join("")}.csv`,$("a.total").onclick=function(e){const t=btoa(unescape(encodeURIComponent(`日期,时间,血糖,备注\n${current().join("\n")}`)));dl.href=`data:text/csv;base64,${t}`,dl.click()},edit(x?localStorage.getItem("d"):raw),$("#myfile").onchange=function(e){Promise.all([].slice.call(e.target.files,0).map((e=>new Promise(((t,n)=>{const o=new FileReader;o.onload=function(){t(o.result)},o.onerror=function(e){n(e)},o.readAsText(e)}))))).then((e=>{edit(e.join("\n").replace(/\n{2,}/g,"\n"))}))},each("#toggleCard,#enter,#myback",(function(e){e.onclick=flip}));
